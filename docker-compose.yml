version: "3"

services:
  price-monitor:
    environment:
      - DD_AGENT_HOST=dd-agent
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://dd-agent:4317
      - DD_SERVICE=sqs-price-monitor
      - DD_ENV=prod
      - DD_VERSION=25.0.0
    build:
      context: ./
      dockerfile: Dockerfile
    container_name: price-monitor
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "2048m"
        max-file: "3"
        tag: "{{.ImageName}}|{{.Name}}"

  dd-agent:
    image: gcr.io/datadoghq/agent:7
    container_name: dd-agent
    labels:
      com.datadoghq.ad.checks: |
        {
          "openmetrics": {
            "init_configs": [{}],
            "instances": [
              {
                "openmetrics_endpoint": "http://droid:8080/metrics",
                "namespace": "osmosisd",
                "metrics": 
                  [
                    {"osmosisd_info": "info"},
                    {"osmosisd_cur_eip_base_fee": "cur_eip_base_fee"}
                  ]
              }#,
              # {
              #   "openmetrics_endpoint": "http://nginx/metrics",
              #   "namespace": "sqs",
              #   "metrics": [".*"]
              # }
            ]
          }
        }
    environment:
      - DD_API_KEY=${DD_API_KEY}
      - DD_SITE=us5.datadoghq.com
      - DD_ENV=prod
      - DD_OTLP_CONFIG_RECEIVER_PROTOCOLS_GRPC_ENDPOINT=0.0.0.0:4317
      - DD_APM_ENABLED=true
      - DD_LOGS_ENABLED=true 
      - DD_LOGS_CONFIG_DOCKER_CONTAINER_FORCE_USE_FILE=true
      - DD_LOGS_CONFIG_CONTAINER_COLLECT_ALL=true
      - DD_CONTAINER_EXCLUDE_LOGS=image:.*agent.* image:.*droid.*
      - DD_OTLP_CONFIG_LOGS_ENABLED=true
      - DD_APM_PROBABILISTIC_SAMPLER_ENABLED=true
      - DD_APM_PROBABILISTIC_SAMPLER_SAMPLING_PERCENTAGE=1

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:rw
      - /proc/:/host/proc/:rw
      - /sys/fs/cgroup/:/host/sys/fs/cgroup:rw
      - /var/lib/docker/containers:/var/lib/docker/containers:rw
      - /opt/datadog/apm:/opt/datadog/apm
    ports:
      - 4317:4317
      - 4318:4318
      - 8126:8126
